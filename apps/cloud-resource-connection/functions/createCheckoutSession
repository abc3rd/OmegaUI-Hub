import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import Stripe from 'npm:stripe@17.4.0';

Deno.serve(async (req) => {
    try {
        const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY'));
        const base44 = createClientFromRequest(req);
        const { profileId, amount, donorName, donorMessage } = await req.json();

        // Validate amount
        if (!amount || amount < 1) {
            return Response.json({ error: 'Minimum donation is $1' }, { status: 400 });
        }

        // Get profile
        const profiles = await base44.asServiceRole.entities.Profile.filter({ id: profileId });
        if (!profiles || profiles.length === 0) {
            return Response.json({ error: 'Profile not found' }, { status: 404 });
        }

        const profile = profiles[0];

        if (!profile.isActive) {
            return Response.json({ error: 'This profile is not currently accepting donations' }, { status: 400 });
        }

        // Create donation record
        const donation = await base44.asServiceRole.entities.Donation.create({
            profileId: profileId,
            amount: amount,
            donorName: donorName || 'Anonymous',
            donorMessage: donorMessage || '',
            status: 'pending'
        });

        // Create Stripe checkout session
        const session = await stripe.checkout.sessions.create({
            payment_method_types: ['card'],
            line_items: [
                {
                    price_data: {
                        currency: 'usd',
                        product_data: {
                            name: `Donation to ${profile.publicName}`,
                            description: profile.story.substring(0, 100),
                        },
                        unit_amount: Math.round(amount * 100), // Convert to cents
                    },
                    quantity: 1,
                },
            ],
            mode: 'payment',
            success_url: `${req.headers.get('origin')}/profile/${profile.publicProfileUrl}?success=true`,
            cancel_url: `${req.headers.get('origin')}/profile/${profile.publicProfileUrl}?canceled=true`,
            metadata: {
                donationId: donation.id,
                profileId: profileId,
                donorName: donorName || 'Anonymous',
                donorMessage: donorMessage || ''
            }
        });

        // Update donation with stripe session ID
        await base44.asServiceRole.entities.Donation.update(donation.id, {
            stripePaymentIntentId: session.id
        });

        return Response.json({ 
            sessionId: session.id,
            url: session.url 
        });

    } catch (error) {
        console.error('Checkout session error:', error);
        return Response.json({ 
            error: 'Failed to create checkout session',
            details: error.message 
        }, { status: 500 });
    }
});