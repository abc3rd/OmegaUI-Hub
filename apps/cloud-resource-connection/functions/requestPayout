import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import Stripe from 'npm:stripe@17.4.0';

Deno.serve(async (req) => {
    try {
        const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY'));
        const base44 = createClientFromRequest(req);
        const user = await base44.auth.me();

        if (!user) {
            return Response.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { profileId, amount, method } = await req.json();

        // Get profile
        const profiles = await base44.entities.Profile.filter({ 
            id: profileId,
            created_by: user.email 
        });

        if (!profiles || profiles.length === 0) {
            return Response.json({ error: 'Profile not found' }, { status: 404 });
        }

        const profile = profiles[0];

        if (!profile.stripeConnectedAccountId) {
            return Response.json({ error: 'No connected account' }, { status: 400 });
        }

        // Validate amount
        if (!amount || amount < 1) {
            return Response.json({ error: 'Minimum payout is $1' }, { status: 400 });
        }

        if (amount > profile.availableBalance) {
            return Response.json({ error: 'Insufficient balance' }, { status: 400 });
        }

        // Create payout
        const payout = await stripe.payouts.create({
            amount: Math.round(amount * 100),
            currency: 'usd',
            method: method || 'standard',
            metadata: {
                profileId: profileId,
                userEmail: user.email
            }
        }, {
            stripeAccount: profile.stripeConnectedAccountId
        });

        // Calculate arrival date (standard: 2-3 business days, instant: within 30 min)
        const arrivalDate = new Date();
        if (method === 'instant') {
            arrivalDate.setMinutes(arrivalDate.getMinutes() + 30);
        } else {
            arrivalDate.setDate(arrivalDate.getDate() + 3);
        }

        // Create payout record
        const payoutRecord = await base44.entities.Payout.create({
            profileId: profileId,
            amount: amount,
            stripePayoutId: payout.id,
            status: 'pending',
            method: method || 'standard',
            arrivalDate: arrivalDate.toISOString()
        });

        // Update profile balance
        await base44.entities.Profile.update(profileId, {
            availableBalance: profile.availableBalance - amount
        });

        return Response.json({ 
            payoutId: payoutRecord.id,
            stripePayoutId: payout.id,
            status: payout.status,
            arrivalDate: arrivalDate.toISOString()
        });

    } catch (error) {
        console.error('Payout error:', error);
        return Response.json({ 
            error: 'Failed to process payout',
            details: error.message 
        }, { status: 500 });
    }
});