
import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import Stripe from 'npm:stripe@17.4.0';

Deno.serve(async (req) => {
    try {
        const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY'));
        const base44 = createClientFromRequest(req);
        
        // Check for authenticated user first
        const user = await base44.auth.me().catch(() => null);

        const { 
            profileId, 
            amount, 
            donorName, 
            donorEmail, 
            donorMessage,
            wishlistItemId,
            latitude,
            longitude
        } = await req.json();

        // Validate amount
        if (!amount || amount < 2) {
            return Response.json({ error: 'Minimum donation is $2' }, { status: 400 });
        }

        // Get profile
        const profiles = await base44.asServiceRole.entities.Profile.filter({ 
            id: profileId 
        });
        
        if (!profiles || profiles.length === 0) {
            return Response.json({ error: 'Profile not found' }, { status: 404 });
        }

        const profile = profiles[0];

        if (!profile.isActive) {
            return Response.json({ error: 'Profile not accepting donations' }, { status: 400 });
        }

        if (!profile.stripeConnectedAccountId) {
            return Response.json({ error: 'Profile not set up for payments' }, { status: 400 });
        }

        // Calculate fees (1% platform fee) using integer math for precision
        const amountInCents = Math.round(amount * 100);
        const platformFeeInCents = Math.round(amountInCents * 0.01);
        const netAmountInCents = amountInCents - platformFeeInCents;

        // Create payment intent with application fee
        const paymentIntent = await stripe.paymentIntents.create({
            amount: amountInCents,
            currency: 'usd',
            application_fee_amount: platformFeeInCents,
            transfer_data: {
                destination: profile.stripeConnectedAccountId,
            },
            metadata: {
                profileId: profileId,
                donorName: donorName || 'Anonymous',
                donorMessage: donorMessage || '',
                wishlistItemId: wishlistItemId || '',
                platformFee: (platformFeeInCents / 100).toFixed(2),
                netAmount: (netAmountInCents / 100).toFixed(2)
            },
            receipt_email: donorEmail,
            description: `Donation to ${profile.publicName}`
        });

        // Create donation record, converting cents back to dollars for storage
        await base44.asServiceRole.entities.Donation.create({
            profileId: profileId,
            donorUserId: user?.id, // Add the user's ID if they are logged in
            grossAmount: amountInCents / 100,
            platformFee: platformFeeInCents / 100,
            netAmount: netAmountInCents / 100,
            donorName: donorName || 'Anonymous',
            donorEmail: donorEmail,
            donorMessage: donorMessage || '',
            wishlistItemId: wishlistItemId,
            stripePaymentIntentId: paymentIntent.id,
            status: 'pending',
            latitude,
            longitude,
        });

        return Response.json({ 
            clientSecret: paymentIntent.client_secret,
            paymentIntentId: paymentIntent.id
        });

    } catch (error) {
        console.error('Payment intent error:', error);
        return Response.json({ 
            error: 'Failed to create payment',
            details: error.message 
        }, { status: 500 });
    }
});
