import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import Stripe from 'npm:stripe@17.4.0';

Deno.serve(async (req) => {
    try {
        const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY'));
        const webhookSecret = Deno.env.get('STRIPE_WEBHOOK_SECRET');
        const base44 = createClientFromRequest(req);
        
        const signature = req.headers.get('stripe-signature');
        const body = await req.text();

        let event;
        try {
            event = stripe.webhooks.constructEvent(body, signature, webhookSecret);
        } catch (err) {
            console.error('Webhook signature verification failed:', err.message);
            return Response.json({ error: 'Invalid signature' }, { status: 400 });
        }

        // Handle the event
        switch (event.type) {
            case 'checkout.session.completed': {
                const session = event.data.object;
                const metadata = session.metadata;

                // Update donation status
                const donations = await base44.asServiceRole.entities.Donation.filter({
                    stripePaymentIntentId: session.id
                });

                if (donations && donations.length > 0) {
                    const donation = donations[0];
                    
                    await base44.asServiceRole.entities.Donation.update(donation.id, {
                        status: 'completed',
                        stripeCustomerId: session.customer
                    });

                    // Update profile's current amount
                    const profile = await base44.asServiceRole.entities.Profile.filter({
                        id: donation.profileId
                    });

                    if (profile && profile.length > 0) {
                        const currentProfile = profile[0];
                        await base44.asServiceRole.entities.Profile.update(currentProfile.id, {
                            currentAmount: (currentProfile.currentAmount || 0) + donation.amount
                        });
                    }
                }
                break;
            }

            case 'checkout.session.expired':
            case 'payment_intent.payment_failed': {
                const session = event.data.object;
                
                const donations = await base44.asServiceRole.entities.Donation.filter({
                    stripePaymentIntentId: session.id
                });

                if (donations && donations.length > 0) {
                    await base44.asServiceRole.entities.Donation.update(donations[0].id, {
                        status: 'failed'
                    });
                }
                break;
            }

            default:
                console.log(`Unhandled event type: ${event.type}`);
        }

        return Response.json({ received: true });

    } catch (error) {
        console.error('Webhook error:', error);
        return Response.json({ 
            error: 'Webhook processing failed',
            details: error.message 
        }, { status: 500 });
    }
});